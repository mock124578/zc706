/*
 * adc_sd_logger.c
 * 模块功能：
 * 负责 ADC 采集并将其保存到 SD 卡。
 */

// (!!!) --- 包含所有需要的头文件 --- (!!!)
#include "adc_sd_logger.h" // 包含我们自己的头文件
#include "ff.h"            // SD 卡文件系统
#include "xil_printf.h"
#include <stdio.h>         // sprintf
#include "adc_core.h"       // adc_init, adc_capture
#include "parameters.h"     // ADC_DDR_BASEADDR
#include <xil_io.h>
#include <xil_cache.h>
#include "xqpsk_hls_top.h"
extern XQpsk_hls_top g_HlsIpInstance;
// (!!!) --- SD 卡全局变量 (从 main.c 移动到这里) --- (!!!)
// 声明为 static，意味着它们是本文件私有的
static FATFS fatfs; // 文件系统对象
static FIL fil;     // 文件对象
static FRESULT Res; // 操作结果
static UINT bw;     // 字节写入计数器
extern struct ad9361_rf_phy *ad9361_phy;


/**
 * @brief (新功能) 这是一个新函数，专门用来“遥控” HLS IP
 */
void run_hardware_demod() {

    // 1. 定义一个 HLS IP 要写入的 DDR 地址
    //    (确保这个地址 0x10000000 是空闲的！)
    //    (!! 注意: char* 是 8 位, HLS IP 需要一个 32/64 位的地址指针 !!)
    UINTPTR ddr_output_buffer_addr = 0x20000000;

    // (!! 2. "配置" HLS IP !!)

    // 告诉 HLS IP 原始 I/Q 样本在 DDR 的哪个地址
    // (这必须是您的 ADC DMA *刚刚*写入的地址！)
    XQpsk_hls_top_Set_ddr_in_buffer(&g_HlsIpInstance, (UINTPTR)ADC_DDR_BASEADDR);

    // 告诉 HLS IP 把 ASCII 结果写到 DDR 的哪个地址
    XQpsk_hls_top_Set_ddr_out_buffer(&g_HlsIpInstance, ddr_output_buffer_addr);

    // 告诉 HLS IP 前导码错误率的输出地址 (HLS 会把结果写到这个 C 变量里)
    int preamble_ser = 0;
    // (!! 关键: 刷新缓存, 确保 HLS 看到的是新地址, 而不是旧数据 !!)
    Xil_DCacheFlushRange((UINTPTR)&preamble_ser, sizeof(int));

    xil_printf("HLS_IP: 正在启动硬件解调...\n");
    fflush(stdout);

    // (!! 3. 按下"启动"按钮 !!)
    XQpsk_hls_top_Start(&g_HlsIpInstance);

    // (!! 4. 等待 HLS IP 完成 !!)
    // (这个 C 语言 while 循环会一直空转，直到 HLS IP 发送“完成”信号)
    while (!XQpsk_hls_top_IsDone(&g_HlsIpInstance));

    xil_printf("HLS_IP: 硬件解调完成！\n");

    // (!! 5. 从 DDR 读回结果并打印 !!)

    // (!! 关键 !!)
    // 因为是“硬件” (HLS IP) 写的内存，CPU 的“缓存”不知道数据更新了
    // 我们必须“刷新缓存”，强制 CPU 去 DDR 读*新*数据
    Xil_DCacheInvalidateRange(ddr_output_buffer_addr, 200); // 刷新 200 字节
    Xil_DCacheInvalidateRange((UINTPTR)&preamble_ser, sizeof(int));

    xil_printf("----------------------------------------\n");
    xil_printf("DECODED PAYLOAD (from Hardware): \n%s\n", (char*)ddr_output_buffer_addr);
    xil_printf("----------------------------------------\n");
    xil_printf("Hardware Preamble SER: %d\n", preamble_ser);
}
/**
 * @brief (实现) 执行 ADC 采集并保存到 SD 卡
 * (这就是从 main.c 剪切过来的函数)
 */
void log_adc_capture_to_sd(struct ad9361_rf_phy *phy, const char *base_filename)
{
    xil_printf("SD_CARD: 正在挂载 SD 卡...\n");
    Res = f_mount(&fatfs, "0:/", 1); // 挂载 SD 卡
    if (Res != FR_OK) {
        xil_printf("SD 卡挂载失败: %d\n", Res);
        return; // 挂载失败，退出函数
    }

    // --- 采集并写入多个文件 ---
    for (int file_idx = 1; file_idx <= 3; file_idx++) {

        // 动态生成文件名
        char filename[64]; // (增加缓冲区大小以防万一)
        sprintf(filename, "0:/%s_%d.txt", base_filename, file_idx);

        Res = f_open(&fil, filename, FA_WRITE | FA_CREATE_ALWAYS);
        if (Res != FR_OK) {
            xil_printf("文件打开失败: %s, 错误码 %d\n", filename, Res);
            continue; // 失败就跳过，尝试下一个
        }

        xil_printf("ADC: 开始采集并写入 %s ...\n", filename);

        // 初始化 ADC 并采集
        adc_init(ad9361_phy);

        uint32_t len = 8196;
        uint32_t segments = 1;
        uint32_t len1 = len * segments;

        adc_capture(len1, ADC_DDR_BASEADDR);

        Xil_DCacheInvalidateRange(ADC_DDR_BASEADDR,
            ad9361_phy->pdata->rx2tx2 ? len1 * 8 : len1 * 4);

        run_hardware_demod();
                /*****************************************/
        xil_printf("SD_CARD: 正在写入数据...\n");
        for(uint32_t seg = 0; seg < segments; seg++) {
            for(uint32_t index = 0; index < len; index++) {
                uint32_t data = Xil_In32(ADC_DDR_BASEADDR + (seg * len + index) * 4);
                uint16_t Q1 = data & 0xFFFF;
                uint16_t I1 = (data >> 16) & 0xFFFF;

                if (Res == FR_OK) {
                    char buf[32];
                    int n = sprintf(buf, "%d,%d\n", (signed short)I1, (signed short)Q1);
                    f_write(&fil, buf, n, &bw);
                }
            }
        }

        f_close(&fil);
        xil_printf("SD_CARD: 文件 %s 写入完成。\n", filename);
    }

    // --- 卸载 SD 卡 ---
    f_mount(NULL, "0:/", 1);
    xil_printf("SD_CARD: 所有 ADC 数据文件已写入, SD 卡已卸载。\n");
}
